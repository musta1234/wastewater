---
title: "ImportUnderreports"
author: "Mustapha Mustapha"
date: "2023-04-06"
output: html_document
---
## This is a script that imports underreports data from IHME

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# April 2023: Undercounting COVID Cases
# clear R's brain
dir.create(tempdir()) # solve Error in file(out, "wt") : cannot open the connection
rm( list = ls())
# load libraries
preq = c( "tidyverse","ggpmisc", "gridExtra", "ggfortify", "scales", 
          "readxl", "readr", "stats", "haven", "Matrix", "foreign",
          "zoo", "prophet", "corrr", "broom", "usethis", "rvest")
#for (y in preq) install.packages(y, dep = TRUE)
sapply(preq, library, character.only=T)

# Set the directory where the files are located
#setwd("C:/Users/mustam23/OneDrive\ -\ Pfizer/Documents/Projects/underreporting")ments/R_github/underreporting/")
```

```{r global_variables, echo=TRUE}

#rm( list = ls())
#file_loc <- "C:/Users/mustam23/OneDrive\ -\ Pfizer/Documents/Projects/wastewater/"
file_loc <- paste0(getwd(), "/../")
data_loc <- paste0(file_loc, "../Data/") # a location for data files 
# check if the string contains "mustam23"
work_laptop <- grepl("mustam23", getwd())
```


##Import IHME Data
```{r IHME_import_function, echo=TRUE}

create_bigfile_from_IHME <- function(){
  
  pop <- 
    read_excel(paste0(data_loc, "world_pop_20231025_worldometer.xlsx")) %>%
    filter(location_name %in% list27)
  
  covariants <- 
    read.csv(paste0(data_loc, "/CoVariants_Scrapped8.csv")) %>% 
    mutate(across(2:length(.), mdy))
  
  list27 <- read.csv(paste0(data_loc, "./list27.txt"), header = F)[ , 1]
  
  bigfile00 <- 
    read.csv(paste0(data_loc, "/Covid-19 Explorer 2023-10-30.csv")) %>%
    select(Location, Day, Measure, Value) %>% 
    mutate(location_name = Location, date = mdy(Day),
         source_var = case_when(Measure == "Infections - Estimated" ~ "inf_mean",
                                Measure == "Infections - Confirmed" ~ "daily_cases",
                                .default = "'Measure' is NA"),
         across('location_name', 
                \(x) str_replace(x, 'United States','United States of America')
                 )
         ) %>%
    select(-Location, -Day, -Measure) %>%
    pivot_wider(names_from = source_var, values_from = Value) %>%
    filter(location_name %in% list27, !is.na(daily_cases)) 
  
  bigfile <- 
    left_join(
      bigfile00%>% select(location_name, date, inf_mean, daily_cases),
      covariants, by=c("location_name" = "location_name")) %>% 
    left_join(., pop, by=c("location_name" = "location_name")) %>% 
    mutate(
      nonvoc = case_when(
        ((date >= start_NonVOC) & (date < end_NonVOC))  ~ 1, .default = 0),
      alpha = case_when(
        ((date >= start_Alpha) & (date < end_Alpha)) ~ 1, .default = 0),
      beta = case_when(
        ((date >= start_Beta) & (date < end_Beta)) ~ 1, .default = 0),
      delta = case_when(
        ((date >= start_Delta) & (date < end_Delta)) ~ 1, .default = 0),
      gamma = case_when(
        ((date >= start_Gamma) & (date < end_Gamma)) ~ 1, .default = 0),
      omicron = case_when(
        ((date >= start_Omicron) & (date < end_Omicron)) ~ 1, .default = 0),
      
      ba1 = case_when(
        ((date >= start_BA.1) & (date < end_BA.1)) ~ 1, .default = 0),
      ba2 = case_when(
        ((date >= start_BA.2) & (date < end_BA.2)) ~ 1, .default = 0),
      ba45 = case_when(
        ((date >= start_BA4BA5) & (date < end_BA4BA5)) ~ 1, .default = 0),
      prealpha = case_when(
        ((date >= start_preAlpha) & (date < end_preAlpha)) ~ 1, .default = 0),
      prebeta = case_when(
        ((date >= start_preBeta) & (date < end_preBeta)) ~ 1, .default = 0),
      predelta = case_when(
        ((date >= start_preDelta) & (date < end_preDelta)) ~ 1, .default = 0),
      pregamma = case_when(
        ((date >= start_preGamma) & (date < end_preGamma)) ~ 1, .default = 0)
      ) %>% 
    
    group_by(location_name) %>%
    mutate(daily_cases_7dt = rollapplyr(daily_cases, 7, mean, fill = NA, align = "right"),
           daily_cases_15dc = rollapplyr(daily_cases, 15, mean, fill = NA, align = "center"),
           idr_v5 = daily_cases_15dc/inf_mean,
           daily_cases_mill = daily_cases * (1000000/ population_2023),
           daily_cases_15dc_mill = daily_cases_15dc * (1000000/ population_2023),
           inf_mean_mill = inf_mean * (1000000/population_2023)
           ) %>%
    
    mutate( 
      variant = case_when(
        nonvoc == 1 ~ "Non-VOC",
        alpha == 1 ~ "Alpha",
        beta == 1 ~ "Beta",
        delta == 1 ~ "Delta",
        gamma == 1 ~ "Gamma",
        omicron == 1 ~ "Omicron",
        prealpha == 1 ~ "Pre-Alpha",
        prebeta == 1 ~ "Pre-Beta",
        pregamma == 1 ~ "Pre-Gamma",
        predelta == 1 ~ "Pre-Delta",
        .default = NA ),
      
      subvariant = case_when(
        ba1 == 1 ~ "BA.1",
        ba2 == 1 ~ "BA.2",
        ba45 == 1 ~ "BA.4 BA.5",
        .default = NA),
      
      continent = case_when(
        location_name %in% c("United States of America", "Canada") ~ "North America",
        location_name %in% c("Japan", "Malaysia", "Israel", "Qatar", "China", "Singapore") ~ "Asia",
        location_name %in% c("United Kingdom", "Italy", "France", "Germany", 
                             "Spain", "Denmark", "Finland", "Sweden", "Netherlands", "Belgium", 
                             "Greece", "Austria", "Portugal", "Ireland", "Luxembourg") ~ "Europe",
        location_name %in% c("Chile",  "Colombia", "Brazil") ~ "South America",
        location_name %in% c("South Africa") ~ "Africa",
        .default = NA),
      
      region = case_when(
        location_name %in% c("Japan", "Malaysia", "China", "Singapore") ~ "East Asia",
        location_name %in% c("Israel", "Qatar") ~ "Middle East",
        .default = continent)
    )
  return(bigfile)
}

#write.csv(bigfile, 
#             file = paste0(getwd(), "/../output/" ,"bigfile_", 
#                           paste(format(Sys.time(), "%Y-%m-%d-%I%p")), ".csv"),
#             quote = TRUE,
#             na = "",
#             row.names = FALSE)

```


##Import IHME Data from function or from presaved file
```{r IHME_import, echo=TRUE}
if (work_laptop) { 
  bigfile <- create_bigfile_from_IHME()
  }else{
    #import bigfile from presaved file
    bigfile <- read.csv(paste0(getwd(), "/data_downloads/bigfile.csv"))
    #select all date columns and convert them to date
    selected_columns <- names(bigfile)[grep("start_|end_|date", names(bigfile))]
    bigfile <- bigfile %>% mutate_at(selected_columns, ymd) 
    }
```


############################### Backup ##################################
############################### Backup ##################################
