---
title: "linear regression models, USA"
author: "MM"
date: "2024-06-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## function to run regression models

```{r linear_regression, echo=TRUE}
run_linear_regression <- function(dataframe, response, predictors) {
  # Create the formula for the linear model
  formula <- as.formula(paste(response, "~", paste(predictors, collapse = "+")))
  
  # Fit the linear model
  model <- lm(formula, data = dataframe)
  
  # Get model summary
  summary_model <- summary(model)
  
  # Extract model parameters
  coefficients <- summary_model$coefficients
  
  # Extract R-squared value
  r_squared <- summary_model$r.squared
  
  # Calculate AIC and BIC
  aic_value <- AIC(model)
  bic_value <- BIC(model)
  
  # Extract residuals
  residuals <- model$residuals
  
  # Calculate predicted values
  predicted_values <- predict(model, dataframe)
  
  # Calculate MAPE
  actual_values <- dataframe[[response]]
  mape <- mean(abs((actual_values - predicted_values) / actual_values), na.rm = TRUE) * 100
  
  # Create a list to store all results
  results <- list(
    coefficients = coefficients,
    r_squared = r_squared,
    aic = aic_value,
    bic = bic_value,
    residuals = residuals,
    predicted_values = predicted_values,
    mape = mape
  )
  
  return(results)
}

# Example usage:
# Assuming 'df' is your dataframe, 'y' is the response variable, and c('x1', 'x2', 'x3') are the predictor variables
# result <- run_linear_regression(df, "y", c("x1", "x2", "x3"))
# print(result)

result <- run_linear_regression(usa_dataset, "hosp_new", c("viral_load"))
print(result)
plot(result$residuals, main = "Residuals vs Fitted Values", xlab = "Fitted Values", ylab = "Residuals")

result <- run_linear_regression(usa_dataset, "hosp_new", c("viral_load"))
print(result)

```
# Run regressions on the usa dataset
```{r run_regressions, echo=TRUE}
#Model 1:  hosp = wastewater
#Model 2: hosp = log(ww)
#Model 3: log(hosp) = log(ww)
#Model 4: hosp = lag1(ww)
#Model 5: hosp = lag1(ww) + days2022 + subvariant
#Model 6: hosp = lag1(ww) + subvariant
#Model 7: hosp = lag1(ww) + days2022

usa_model1 <- run_linear_regression(usa_dataset, "hosp_new", c("viral_load"))
usa_model2 <- run_linear_regression(usa_dataset, "hosp_new", c("log_viral_load"))
usa_model3 <- run_linear_regression(usa_dataset, "log_hosp", c("log_viral_load"))
usa_model4 <- run_linear_regression(usa_dataset, "hosp_new", c("lag1_viral_load"))
usa_model5 <- run_linear_regression(usa_dataset %>% mutate(days2022 = as.numeric(date - min(date))),
                                    "hosp_new", c("lag1_viral_load", "days2022", "subvariant"))
usa_model6 <- run_linear_regression(usa_dataset, 
                                    "hosp_new", c("lag1_viral_load", "subvariant"))
usa_model7 <- run_linear_regression(usa_dataset %>% mutate(days2022 = as.numeric(date - min(date))),
                                    "hosp_new", c("lag1_viral_load", "days2022"))
                                   
#usa_models <- list(usa_model1, usa_model2, usa_model3)
# Print the results
print(usa_model1)
print(usa_model2)
print(usa_model3)
print(usa_model4)
print(usa_model5)
print(usa_model6)
print(usa_model7)



usa_dataset_models <- usa_dataset
usa_dataset_models$predicted_m1 <- usa_model1$predicted_values
usa_dataset_models$predicted_m2 <- usa_model2$predicted_values
usa_dataset_models$predicted_m3 <- 
  usa_model3$predicted_values %>% exp() #undo the log transformation
usa_dataset_models$predicted_m4 <- usa_model4$predicted_values
usa_dataset_models$predicted_m5 <- usa_model5$predicted_values
usa_dataset_models$predicted_m6 <- usa_model6$predicted_values
usa_dataset_models$predicted_m7 <- usa_model7$predicted_values

usa_dataset_models$residuals_m1 <- usa_model1$residuals
usa_dataset_models$residuals_m2 <- usa_model2$residuals
usa_dataset_models$residuals_m3 <- usa_model3$residuals
usa_dataset_models$residuals_m4 <- c(NA, usa_model4$residuals)
usa_dataset_models$residuals_m5 <- c(NA, usa_model5$residuals)
usa_dataset_models$residuals_m6 <- c(NA, usa_model6$residuals)
usa_dataset_models$residuals_m7 <- c(NA, usa_model7$residuals)

usa_model1_csv <-
  data.frame(
    usa_model1$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model1$r_squared,
    usa_model1$aic,
    usa_model1$bic,
    usa_model1$mape)

usa_model2_csv <-
  data.frame(
    usa_model2$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model2$r_squared,
    usa_model2$aic,
    usa_model2$bic,
    usa_model2$mape)

usa_model3_csv <-
  data.frame(
    usa_model3$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model3$r_squared,
    usa_model3$aic,
    usa_model3$bic,
    usa_model3$mape)

usa_model4_csv <-
  data.frame(
    usa_model4$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model4$r_squared,
    usa_model4$aic,
    usa_model4$bic,
    usa_model4$mape)

usa_model5_csv <-
  data.frame(
    usa_model5$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model5$r_squared,
    usa_model5$aic,
    usa_model5$bic,
    usa_model5$mape)

usa_model6_csv <-
  data.frame(
    usa_model6$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model6$r_squared,
    usa_model6$aic,
    usa_model6$bic,
    usa_model6$mape)

usa_model7_csv <-
  data.frame(
    usa_model7$coefficients %>% t() %>% 
      as.data.frame() %>% 
      rownames_to_column("variable"),
    usa_model7$r_squared,
    usa_model7$aic,
    usa_model7$bic,
    usa_model7$mape)
  
```

# plot predicted and observed hospitalizations
```{r plot_predicted_observed, echo=TRUE}
# Plot predicted vs observed hospitalizations for Model 5

ggplot(usa_dataset_models, aes(x = hosp_new)) +
  geom_point(aes(y=predicted_m6), color = "blue3") +
  #geom_line(aes(y=hosp_new), color = "red2") +
  #geom_point(aes(y=predicted_m1), color = "black") +
  labs(title = "Predicted Model 5 vs Observed Hospitalizations",
       x = "Observed",
       y = "Predicted Hospitalizations")



ggplot(usa_dataset_models, aes(x = date)) +
  geom_line(aes(y=predicted_m1), color = "blue3") +
  geom_line(aes(y=predicted_m6), color = "red2") +
  geom_line(aes(y=hosp_new), color = "black", linetype=2) +
  #geom_abline(intercept = 0, slope = 1, color = "red") +
  labs(title = "Predicted Model 1 (blue) vs Model 6 (red) vs Observed (dashed) 
       New Covid Hospitalizations, USA, 2022-2024",
       x = "Date",
       y = "Predicted Hospitalizations") 





```