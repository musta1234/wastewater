---
title: "ImportUnderreports"
author: "Mustapha Mustapha"
date: "2023-04-06"
output: html_document
---
## This is a script that imports underreports data from IHME

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# April 2023: Undercounting COVID Cases
# clear R's brain
rm( list = ls())
# load libraries
preq = c( "dplyr", "ggplot2", "ggfortify", "readxl", "readr", 
          "stats", "tidyverse", "haven", "Matrix", "foreign", "zoo", "prophet")
#for (y in preq) install.packages(y, dep = TRUE)
sapply(preq, library, character.only=T)
#install.packages("prophet", dep = T)

# Set the directory where the files are located
setwd("C:/Users/mustam23/OneDrive\ -\ Pfizer/Documents/Projects/underreporting") #setwd("G:/My\ Drive/Documents/R_github/underreporting/")

file_loc <- "C:/Users/mustam23/OneDrive\ -\ Pfizer/Documents/Projects/underreporting"
```

##Import IHME Data
```{r IHME_import, echo=TRUE}
rm( list = ls())
file_loc <- "C:/Users/mustam23/OneDrive\ -\ Pfizer/Documents/Projects/underreporting"

#bigfile is "data_regions" dataframe from "data_cleaning_underreports.Rmd"
bigfile00 <- read.csv(paste0(file_loc, "/output/bigfile.csv")) #names(bigfile)

places <- bigfile00$location_name %>% sort() %>% unique()

list27 <- read.csv(paste0(file_loc, "./list27.txt"), header = F)[ , 1]
#list26 %in% places

#keeping only countries in our list of 27
bigfile00 <- 
  bigfile00 %>% filter(location_name %in% list27) %>% mutate(date= ymd(date))

```


```{r red_covariannts_deprecated, echo=TRUE}

covariants <- 
  read.csv(paste0(file_loc, "/Data/CoVariants_Scrapped4.csv")) %>% 
  select(-1) %>% 
  mutate(across(2:length(.), mdy)) 
```

```{r merge_variants, echo=TRUE}
#Adding covariants to bigfile
bigfile <- 
  
  left_join(bigfile00%>% select(location_name, date, inf_mean, daily_cases), 
            covariants, by=c("location_name" = "location_name")) %>% 
  #note misspelling of "end_widtype"
  mutate(wildtype = ((date - start_wildtype) >= 0) & (date - end_widtype) <=0) %>% 
  mutate(alpha = ((date - start_Alpha) >= 0) & (date - end_Alpha) <=0) %>% 
  mutate(beta = ((date - start_Beta) >= 0) & (date - end_Beta) <=0) %>%
  mutate(delta = ((date - start_Delta) >= 0) & (date - end_Delta) <=0) %>%
  mutate(gamma = ((date - start_Gamma) >= 0) & (date - end_Gamma) <=0) %>% 
  mutate(omicron = ((date - start_Omicron) >= 0) & (date - end_Omicron) <=0) %>%

  mutate(ba1 = ((date - start_BA.1) >= 0) & (date - end_BA.1) <=0) %>% 
  mutate(ba2 = ((date - start_BA.2) >= 0) & (date - end_BA.2) <=0) %>% 
  mutate(ba45 = ((date - start_BA4BA5) >= 0) & (date - end_BA4BA5) <=0) %>%
  
  #Convert this section using if_else
  mutate(prealpha = ((date - start_preAlpha) >= 0) & (date - end_preAlpha) <=0) %>%
  mutate(prebeta = ((date - start_preBeta) >= 0) & (date - end_preBeta) <=0) %>%
  mutate(predelta = ((date - start_preDelta) >= 0) & (date - end_preDelta) <=0) %>%
  mutate(gamma = ((date - start_preGamma) >= 0) & (date - end_preGamma) <=0) %>% 
  #select(-starts_with("end_"), -starts_with("start_"))
  #mutate(date= ymd(date)) %>% 
  
  # selected_bigfile  bigfile %>% #filter(location_name %in% list27) %>% 
  group_by(location_name) %>%
  mutate(daily_cases_7d = rollapplyr(daily_cases, 7, mean, fill = NA, align = "right")) %>% 
  mutate(daily_slope = (daily_cases_7d - lag(daily_cases_7d))/daily_cases_7d) %>%
  mutate(inf_mean_7d = rollapplyr(inf_mean, 7, mean, fill = NA, align = "right")) %>%
  mutate(inf_mean_7d_f = rollapplyr(inf_mean, 7, mean, fill = NA, align = "left")) %>%
  mutate(daily_cases_7d_f = rollapplyr(daily_cases, 7, mean, fill = NA, align = "left")) %>%
  mutate(daily_cases_7d_c = rollapplyr(daily_cases, 7, mean, fill = NA, align = "center")) %>%
  mutate(inf_mean_7d_c = rollapplyr(inf_mean, 7, mean, fill = NA, align = "center")) %>%
  mutate(daily_cases_15d = rollapplyr(daily_cases, 15, mean, fill = NA, align = "right")) %>%
  mutate(daily_cases_15d_c = rollapplyr(daily_cases, 15, mean, fill = NA, align = "center")) %>%
  
  mutate(daily_cases_15d_f = rollapplyr(daily_cases, 15, mean, fill = NA, align = "left")) %>%
  mutate(inf_mean_15d_f = rollapplyr(inf_mean, 15, mean, fill = NA, align = "left")) %>%
  
  #idr_v7
  mutate(daily_cases_14d_f = rollapplyr(daily_cases, 14, mean, fill = NA, align = "left")) %>%
  mutate(inf_mean_14d_f = rollapplyr(inf_mean, 14, mean, fill = NA, align = "left")) %>%

  mutate(idr_v1 = daily_cases_7d/inf_mean) %>%
  mutate(idr_v2 = daily_cases_7d/inf_mean_7d) %>% 
  mutate(idr_v3 = daily_cases_7d_c/inf_mean) %>% 
  mutate(idr_v4 = daily_cases_15d_c/inf_mean) %>% 
  mutate(idr_v5 = daily_cases_15d/inf_mean) %>%
  mutate(idr_v6 = daily_cases_7d_f/inf_mean) %>%
  mutate(idr_v7 = daily_cases_7d_f/inf_mean_7d_f) %>%
  mutate(idr_v8 = daily_cases_14d_f/inf_mean_14d_f) %>%
  mutate(idr_v9 = daily_cases_14d_f/inf_mean) %>%
  mutate(idr_v10 = daily_cases_15d_f/inf_mean) %>%
  mutate(idr_v11 = daily_cases_15d_f/inf_mean_15d_f) %>% 
  
  
  ### big_regions <- 
  #bigfile %>%
  #select(-case_detection) %>%
  mutate(case_detection_7d = daily_cases_7d/inf_mean,
         case_detection_7d = daily_cases_7d/inf_mean,) %>%
  mutate( variant = case_when(
    alpha == 1 ~ "Alpha",
    beta == 1 ~ "Beta",
    delta == 1 ~ "Delta",
    gamma == 1 ~ "Gamma",
    omicron == 1 ~ "Omicron",
    .default = "None"
    )) %>%
  mutate( continent = case_when(
    location_name %in% c("United States of America", "Canada") ~ "North America",
    location_name %in% c("Japan", "Malaysia", "Israel", "Qatar", "China", "Singapore") ~ "Asia",
    # look into UN regions "East Asia" and Middle East "Japan", "Malaysia", "Israel", "Qatar ", "China", "Singapore"
    location_name %in% c("United Kingdom", "Italy", "France", "Germany", "Spain", "Denmark", "Finland", "Sweden", "Netherlands", "Belgium", "Greece", "Austria", "Portugal", "Ireland ", "Luxembourg") ~ "Europe",
    location_name %in% c("Chile",  "Colombia", "Brazil") ~ "South America",
    location_name %in% c("South Africa") ~ "Africa",
    .default = NA
  )) %>% 
    mutate( region = case_when(
    location_name %in% c("Japan", "Malaysia", "China", "Singapore") ~ "East Asia",
    location_name %in% c("Israel", "Qatar") ~ "Middle East",
    .default = continent
  ))  
  

```

##modify IHME Data
```{r lead_lagger, echo=TRUE}
lead_lagger <- function(infile=selected_bigfile, infname=inf_mean, casesname=daily_cases_7d){
  #function(infile=selected_bigfile, infname=inf_mean, casesname=daily_cases_7d)
  tempfile<- infile %>% 
    group_by(location_name) %>% 
    #filter(location_name) %>% 
    summarize(cor_l28 = cor({{infname}}, lag({{casesname}}, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor({{infname}}, lag({{casesname}}, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor({{infname}}, lag({{casesname}}, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor({{infname}}, lag({{casesname}}, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor({{infname}}, lag({{casesname}}, n = 7), use = "pairwise.complete.obs"),
              cor_l6 = cor({{infname}}, lag({{casesname}}, n = 6), use = "pairwise.complete.obs"),
              cor_l5 = cor({{infname}}, lag({{casesname}}, n = 5), use = "pairwise.complete.obs"),
              cor_l4 = cor({{infname}}, lag({{casesname}}, n = 4), use = "pairwise.complete.obs"),
              cor_l3 = cor({{infname}}, lag({{casesname}}, n = 3), use = "pairwise.complete.obs"),
              cor_l2 = cor({{infname}}, lag({{casesname}}, n = 2), use = "pairwise.complete.obs"),
              cor_l1 = cor({{infname}}, lag({{casesname}}, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor({{infname}}, {{casesname}}, use = "pairwise.complete.obs"),
              cor_f1 = cor({{infname}}, lead({{casesname}}, n = 1), use = "pairwise.complete.obs"),
              cor_f2 = cor({{infname}}, lead({{casesname}}, n = 2), use = "pairwise.complete.obs"),
              cor_f3 = cor({{infname}}, lead({{casesname}}, n = 3), use = "pairwise.complete.obs"),
              cor_f4 = cor({{infname}}, lead({{casesname}}, n = 4), use = "pairwise.complete.obs"),
              cor_f5 = cor({{infname}}, lead({{casesname}}, n = 5), use = "pairwise.complete.obs"),
              cor_f6 = cor({{infname}}, lead({{casesname}}, n = 6), use = "pairwise.complete.obs"),
              cor_f7 = cor({{infname}}, lead({{casesname}}, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor({{infname}}, lead({{casesname}}, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor({{infname}}, lead({{casesname}}, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor({{infname}}, lead({{casesname}}, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor({{infname}}, lead({{casesname}}, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor({{infname}}, lead({{casesname}}, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor({{infname}}, lead({{casesname}}, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor({{infname}}, lead({{casesname}}, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor({{infname}}, lead({{casesname}}, n = 15), use = "pairwise.complete.obs"),
              cor_f16 = cor({{infname}}, lead({{casesname}}, n = 16), use = "pairwise.complete.obs"),
              cor_f17 = cor({{infname}}, lead({{casesname}}, n = 17), use = "pairwise.complete.obs"),
              cor_f18 = cor({{infname}}, lead({{casesname}}, n = 18), use = "pairwise.complete.obs"),
              cor_f19 = cor({{infname}}, lead({{casesname}}, n = 19), use = "pairwise.complete.obs"),
              cor_f20 = cor({{infname}}, lead({{casesname}}, n = 20), use = "pairwise.complete.obs"),
              cor_f21 = cor({{infname}}, lead({{casesname}}, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor({{infname}}, lead({{casesname}}, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()
  return(tempfile)
  }

```

```{r variants_lead_lagger, echo=TRUE}
z <-
  lead_lagger(infile=selected_bigfile, 
              infname=inf_mean, casesname=daily_cases_15d_c) %>% 
  select(-location_name) %>%
  apply(., 2, median, na.rm = TRUE)
a <- 
  lead_lagger(infile=selected_bigfile %>% filter(alpha == 1), 
              infname=inf_mean, casesname=daily_cases_15d_c) %>% 
  select(-location_name) %>%
  apply(., 2, median, na.rm = TRUE)
b <- 
  lead_lagger(infile=selected_bigfile %>% filter(beta == 1), 
              infname=inf_mean, casesname=daily_cases_15d_c) %>% 
  select(-location_name) %>%
  apply(., 2, median, na.rm = TRUE)
d <- 
  lead_lagger(infile=selected_bigfile %>% filter(delta == 1), 
              infname=inf_mean, casesname=daily_cases_15d_c) %>% 
  select(-location_name) %>%
  apply(., 2, median, na.rm = TRUE)
g <- 
  lead_lagger(infile=selected_bigfile %>% filter(gamma == 1), 
              infname=inf_mean, casesname=daily_cases_15d_c) %>% 
  select(-location_name) %>%
  apply(., 2, median, na.rm = TRUE)
o <- 
  lead_lagger(infile=selected_bigfile %>% filter(omicron == 1), 
              infname=inf_mean, casesname=daily_cases_15d_c) %>% 
  select(-location_name) %>%
  apply(., 2, median, na.rm = TRUE)

x <-
  data.frame(z, a, b, d, g, o)

x$leadlag_days <- 
  row.names(x) %>% gsub("cor_l", "-", .) %>% 
  gsub("cor_f|cor_", "", ., perl = T) %>% as.numeric()

row.names(x) <- NULL
names(x) <- c("All", "Alpha", "Beta", "Delta", "Gamma", "Omicron", "Days")

variant_median <- x %>% relocate(Days)

write.csv(variant_median, 
             file = paste0(getwd(), "/../output/" ,"variant_median", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)

# On which day do we have peak correlation for each variant?
#x$Days[which.max(x$Omicron)]
rm( list = c("a","b","d","g","o","z","x"))


```


  #create a continent variable from 27 
#2x3 Panel plot - case detection rate. Continent specific plot with a line per country.
# ggplot or Stata
  
#%>% View()

#table( bigtest %>% select(alpha, beta, gamma, delta, omicron, variant) , useNA = "always") %>% View()

```{r summarize_ihme_fn, echo=TRUE}
summarize_ihme <- function(ihme_data, var1, var2 = "", metric= case_detection_7d){
  ihme_data %>%
    #filter(!is.na(daily_cases_7d)) %>% 
    group_by({{var1}}, {{var2}}) %>% 
    filter( !is.na(daily_cases)) %>%
    summarize(
      n_ascert = sum(!is.na(daily_cases)),
      n_daily_cases = sum(!is.na(daily_cases)),
      NAs = sum(is.na(daily_cases)),
      n_zeros = sum(!is.na(daily_cases) & (daily_cases == 0)),
      n_1to9 = sum(!is.na(daily_cases) & (daily_cases <10) & (daily_cases >0)),
      min_date = min(as.Date(date), na.rm = TRUE),
      max_date = max(as.Date(date), na.rm = TRUE),
      mean = mean({{metric}}, na.rm = TRUE),
      max = max({{metric}}, na.rm = TRUE),
      min = min({{metric}}, na.rm = TRUE),
      median = median({{metric}}, na.rm = TRUE),
      upper_quartile = quantile({{metric}}, 0.75,na.rm = TRUE),
      lower_quartile = quantile({{metric}}, 0.25, na.rm = TRUE),
      q5 = quantile({{metric}}, 0.05, na.rm = TRUE),
      q95 = quantile({{metric}}, 0.95, na.rm = TRUE),

      over_reports = sum(!is.na(case_detection_7d) & (case_detection_7d >1 ))
  )
}
```

```{r summarize_ihme, echo=TRUE}

#all countries
a <- summarize_ihme(ihme_data=bigfile, var1 = location_name, var2 = "", metric= idr_v4) %>%
  rename(var1 = 1, var2 =2)
#country by variant
b <- summarize_ihme(ihme_data=bigfile, var1 = location_name, var2 = variant, metric= idr_v4) %>% 
  rename(var1 = 1, var2 =2)
#continent all
c <- summarize_ihme(ihme_data=bigfile, var1 = continent, var2 = "", metric= idr_v4) %>%
  rename(var1 = 1, var2 =2)
#continent by variant
d <- summarize_ihme(ihme_data=bigfile, var1 = continent, var2 = variant, metric= idr_v4) %>%
  rename(var1 = 1, var2 =2)
#Region All
e <- summarize_ihme(ihme_data=bigfile, var1 = region, var2 = "", metric= idr_v4) %>%
  rename(var1 = 1, var2 =2)
#Region by variant
f <- summarize_ihme(ihme_data=bigfile, var1 = region, var2 = "", metric= idr_v4) %>%
  rename(var1 = 1, var2 =2)

summary_stats <- 
  rbind(a,b,c,d,e,f) %>% rename(location = var1, variant = var2) %>% 
  mutate(variant = case_when(variant == "" ~ "All", .default = variant)) %>% 
  select(-n_ascert, -NAs)

write.csv(summary_stats, 
             file = paste0(getwd(), "/../output/" ,"summary_stats_", 
                           paste(format(Sys.time(), "%Y-%m-%d-%I%p")), ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)

```
```{r summarize_ihme_backup, echo=TRUE}
stats_loc <- summarize_ihme(data_regions, location_name)


summarize_ihme_old <- function(ihme_data, var1, var2 = "", metric= case_detection_7d){
  ihme_data %>%
    #filter(!is.na(daily_cases_7d)) %>% 
    group_by({{var1}}, {{var2}}) %>% 
    summarize(
      #n_ascert = sum(!is.na(daily_cases)),
      n_daily_cases = sum(!is.na(daily_cases)),
      NAs = sum(is.na(daily_cases)),
      n_zeros = sum(!is.na(daily_cases) & (daily_cases == 0)),
      n_1to9 = sum(!is.na(daily_cases) & (daily_cases <10) & (daily_cases >0)),
      min_date = min(as.Date(date), na.rm = TRUE),
      max_date = max(as.Date(date), na.rm = TRUE),
      mean = mean(case_detection, na.rm = TRUE),
      max = max(case_detection, na.rm = TRUE),
      min = min(case_detection, na.rm = TRUE),
      median = median(case_detection, na.rm = TRUE),
      upper_quartile = quantile(case_detection, 0.75,na.rm = TRUE),
      lower_quartile = quantile(case_detection, 0.25, na.rm = TRUE)
  )
}

# calculate summary stats for region and country and by quarter
#stats_region <- summarize_ihme(data_regions, region)
stats_loc <- summarize_ihme(data_regions, location_name)
stats_loc_qtr <- summarize_ihme(data_regions, location_name, year_quarter)
#stats_region_qtr <- summarize_ihme(data_regions, region, year_quarter)

#export summary stats
for (name in c("stats_loc", "stats_loc_qtr", "stats_country_ranks")){
  df <- get(name)
  write.csv(df, file = paste0(name, ".csv"))
}


summarize_ihme_backup <- function(ihme_data, var1, var2 = ""){
  ihme_data %>%
    filter(!is.na(daily_cases_7d)) %>% 
    group_by({{var1}}, {{var2}}) %>% 
    summarize(
      n = sum(!is.na(case_detection)),
      min_date = min(as.Date(date), na.rm = TRUE),
      max_date = max(as.Date(date), na.rm = TRUE),
      mean = mean(case_detection, na.rm = TRUE),
      max = max(case_detection, na.rm = TRUE),
      min = min(case_detection, na.rm = TRUE),
      median = median(case_detection, na.rm = TRUE),
      upper_quartile = quantile(case_detection, 0.75,na.rm = TRUE),
      lower_quartile = quantile(case_detection, 0.25, na.rm = TRUE)
  )
}

stats_country_ranks <- 
  data_regions %>% group_by(location_name) %>%
  summarize(
        na_daily_cases = sum(is.na(daily_cases)),
        zero_daily_cases = sum(daily_cases==0, na.rm = TRUE)
        ) %>% 
  mutate(nazero_daily_cases = na_daily_cases - 110 + zero_daily_cases) %>%
  #arrange by descending missingness score, nazero_daily_cases
  arrange(desc(nazero_daily_cases)) %>%
  mutate(completeness_rank = rank(nazero_daily_cases, ties.method = "random"))

#generate summary stats by one or two grouping variables

```


############################### Backup ##################################
############################### Backup ##################################
############################### Backup ##################################
############################### Backup ##################################
############################### Backup ##################################
############################### Backup ##################################
############################### Backup ##################################
############################### Backup ##################################

```{r big_regios, echo=TRUE}

big_regions <- 
  bigfile %>%
  select(-case_detection) %>%
  mutate(case_detection_7d = daily_cases_7d/inf_mean,
         case_detection_7d = daily_cases_7d/inf_mean,) %>%
  mutate( variant = case_when(
    alpha == 1 ~ "Alpha",
    beta == 1 ~ "Beta",
    delta == 1 ~ "Delta",
    gamma == 1 ~ "Gamma",
    omicron == 1 ~ "Omicron",
    .default = "None"
    )) %>%
  mutate( continent = case_when(
    location_name %in% c("United States of America", "Canada") ~ "North America",
    location_name %in% c("Japan", "Malaysia", "Israel", "Qatar", "China", "Singapore") ~ "Asia",
    # look into UN regions "East Asia" and Middle East "Japan", "Malaysia", "Israel", "Qatar ", "China", "Singapore"
    location_name %in% c("United Kingdom", "Italy", "France", "Germany", "Spain", "Denmark", "Finland", "Sweden", "Netherlands", "Belgium", "Greece", "Austria", "Portugal", "Ireland ", "Luxembourg") ~ "Europe",
    location_name %in% c("Chile",  "Colombia", "Brazil") ~ "South America",
    location_name %in% c("South Africa") ~ "Africa",
    .default = NA
  )) %>% 
    mutate( region = case_when(
    location_name %in% c("Japan", "Malaysia", "China", "Singapore") ~ "East Asia",
    location_name %in% c("Israel", "Qatar") ~ "Middle East",
    .default = continent
  ))

##Join IHME and covariants data


```{r read_covariannts_deprecated, echo=TRUE}
covariants <- read.csv(paste0(file_loc, "/Data/CoVariants_Scrapped3.csv")) #names(bigfile)
names(covariants) <- c("location_name", "variant", "startweek", "endweek", "variantdays")
covariants_wide <- 
  covariants %>% select(-variantdays) %>% 
  mutate(startweek =mdy(startweek), endweek =mdy(endweek)) %>%
  pivot_wider(names_from = variant, values_from = c(startweek, endweek))

bigfile <- 
  
  left_join(bigfile00, covariants_wide, by=c("location_name" = "location_name")) %>% 
  mutate(date= ymd(date)) %>% 
  mutate(alpha = ((date - startweek_Alpha) >= 0) & (date - endweek_Alpha) <=0) %>%
  mutate(beta = ((date - startweek_Beta) >= 0) & (date - endweek_Beta) <=0) %>%
  mutate(delta = ((date - startweek_Delta) >= 0) & (date - endweek_Delta) <=0) %>%
  mutate(gamma = ((date - startweek_Gamma) >= 0) & (date - endweek_Gamma) <=0) %>% 
  mutate(omicron = ((date - startweek_Omicron) >= 0) & (date - endweek_Omicron) <=0) %>% 
  
  mutate(alpha = ifelse(is.na(alpha), 0, alpha)) %>%
  mutate(beta = ifelse(is.na(beta), 0, beta)) %>%
  mutate(gamma = ifelse(is.na(gamma), 0, gamma)) %>%
  mutate(delta = ifelse(is.na(delta), 0, delta)) %>%
  mutate(omicron = ifelse(is.na(omicron), 0, omicron)) %>%
  
  select(-starts_with("endweek"), -starts_with("startweek"), -X)

```

```{r selected_bigfile_deprecated, echo=TRUE}
selected_bigfile <- 
  bigfile %>% #filter(location_name %in% list27) %>% 
  group_by(location_name) %>%
  mutate(daily_cases_7d = rollapplyr(daily_cases, 7, mean, fill = NA, align = "right")) %>% 
  mutate(daily_slope = (daily_cases_7d - lag(daily_cases_7d))/daily_cases_7d) %>%
  mutate(inf_mean_7d = rollapplyr(inf_mean, 7, mean, fill = NA, align = "right")) %>%
  mutate(inf_mean_7d_f = rollapplyr(inf_mean, 7, mean, fill = NA, align = "left")) %>%
  mutate(daily_cases_7d_f = rollapplyr(daily_cases, 7, mean, fill = NA, align = "left")) %>%
  mutate(daily_cases_7d_c = rollapplyr(daily_cases, 7, mean, fill = NA, align = "center")) %>%
  mutate(inf_mean_7d_c = rollapplyr(inf_mean, 7, mean, fill = NA, align = "center")) %>%
  mutate(daily_cases_15d = rollapplyr(daily_cases, 15, mean, fill = NA, align = "right")) %>%
  mutate(daily_cases_15d_c = rollapplyr(daily_cases, 15, mean, fill = NA, align = "center")) %>%
  
  mutate(daily_cases_15d_f = rollapplyr(daily_cases, 15, mean, fill = NA, align = "left")) %>%
  mutate(inf_mean_15d_f = rollapplyr(inf_mean, 15, mean, fill = NA, align = "left")) %>%
  
  #idr_v7
  mutate(daily_cases_14d_f = rollapplyr(daily_cases, 14, mean, fill = NA, align = "left")) %>%
  mutate(inf_mean_14d_f = rollapplyr(inf_mean, 14, mean, fill = NA, align = "left")) %>%

  mutate(idr_v1 = daily_cases_7d/inf_mean) %>%
  mutate(idr_v2 = daily_cases_7d/inf_mean_7d) %>% 
  mutate(idr_v3 = daily_cases_7d_c/inf_mean) %>% 
  mutate(idr_v4 = daily_cases_15d_c/inf_mean) %>% 
  mutate(idr_v5 = daily_cases_15d/inf_mean) %>%
  mutate(idr_v6 = daily_cases_7d_f/inf_mean) %>%
  mutate(idr_v7 = daily_cases_7d_f/inf_mean_7d_f) %>%
  mutate(idr_v8 = daily_cases_14d_f/inf_mean_14d_f) %>%
  mutate(idr_v9 = daily_cases_14d_f/inf_mean) %>%
  mutate(idr_v10 = daily_cases_15d_f/inf_mean) %>%
  mutate(idr_v11 = daily_cases_15d_f/inf_mean_15d_f)

#selected_bigfile %>% select(date, location_name, idr_v7) %>% 
#  filter(idr_v7>1) %>%
#  group_by(location_name) %>% count(location_name) %>% View()

  #calculate idr_s with a lag
```
```{r IHME_import, echo=TRUE}
#lead_lag_01
######################

lead_lag_01 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_01, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_01", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#####

#lead_lag_02
###################################
lead_lag_02 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases_7d, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases_7d, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases_7d, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases_7d, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases_7d, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases_7d, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases_7d, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases_7d, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases_7d, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases_7d, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases_7d, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases_7d, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases_7d, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases_7d, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases_7d, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases_7d, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases_7d, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases_7d, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases_7d, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases_7d, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases_7d, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases_7d, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases_7d, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_02, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_02", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#################################

#lead_lag_03
###################################
lead_lag_03 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases_7d_c, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases_7d_c, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases_7d_c, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases_7d_c, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases_7d_c, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases_7d_c, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases_7d_c, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases_7d_c, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases_7d_c, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases_7d_c, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases_7d_c, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases_7d_c, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases_7d_c, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases_7d_c, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases_7d_c, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases_7d_c, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases_7d_c, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases_7d_c, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases_7d_c, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases_7d_c, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases_7d_c, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases_7d_c, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases_7d_c, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_03, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_03", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#################################

#lead_lag_04
###################################
lead_lag_04 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases_15d, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases_15d, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases_15d, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases_15d, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases_15d, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases_15d, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases_15d, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases_15d, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases_15d, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases_15d, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases_15d, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases_15d, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases_15d, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases_15d, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases_15d, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases_15d, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases_15d, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases_15d, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases_15d, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases_15d, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases_15d, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases_15d, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases_15d, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_04, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_04", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#################################

#lead_lag_05
###################################
lead_lag_05 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases_15d_c, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases_15d_c, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases_15d_c, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases_15d_c, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases_15d_c, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases_15d_c, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases_15d_c, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases_15d_c, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases_15d_c, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases_15d_c, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases_15d_c, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases_15d_c, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases_15d_c, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases_15d_c, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases_15d_c, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases_15d_c, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases_15d_c, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases_15d_c, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases_15d_c, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases_15d_c, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases_15d_c, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases_15d_c, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases_15d_c, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_05, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_05", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#################################

#lead_lag_06
###################################
lead_lag_06 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases_7d_f, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases_7d_f, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases_7d_f, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases_7d_f, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases_7d_f, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases_7d_f, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases_7d_f, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases_7d_f, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases_7d_f, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases_7d_f, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases_7d_f, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases_7d_f, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases_7d_f, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases_7d_f, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases_7d_f, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases_7d_f, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases_7d_f, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases_7d_f, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases_7d_f, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases_7d_f, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases_7d_f, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases_7d_f, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases_7d_f, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_06, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_06", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#################################

#lead_lag_07
###################################
lead_lag_07 <-
  selected_bigfile %>% 
    group_by(location_name) %>% 
    summarize(cor_l28 = cor(inf_mean, lag(daily_cases_15d_f, n = 28), use = "pairwise.complete.obs"),
              cor_l21 = cor(inf_mean, lag(daily_cases_15d_f, n = 21), use = "pairwise.complete.obs"),
              cor_l14 = cor(inf_mean, lag(daily_cases_15d_f, n = 14), use = "pairwise.complete.obs"),
              cor_l10 = cor(inf_mean, lag(daily_cases_15d_f, n = 10), use = "pairwise.complete.obs"),
              cor_l7 = cor(inf_mean, lag(daily_cases_15d_f, n = 7), use = "pairwise.complete.obs"),
              cor_l5 = cor(inf_mean, lag(daily_cases_15d_f, n = 5), use = "pairwise.complete.obs"),
              cor_l3 = cor(inf_mean, lag(daily_cases_15d_f, n = 3), use = "pairwise.complete.obs"),
              cor_l1 = cor(inf_mean, lag(daily_cases_15d_f, n = 1), use = "pairwise.complete.obs"),
              cor_00 = cor(inf_mean, daily_cases_15d_f, use = "pairwise.complete.obs"),
              cor_f1 = cor(inf_mean, lead(daily_cases_15d_f, n = 1), use = "pairwise.complete.obs"),
              cor_f3 = cor(inf_mean, lead(daily_cases_15d_f, n = 3), use = "pairwise.complete.obs"),
              cor_f5 = cor(inf_mean, lead(daily_cases_15d_f, n = 5), use = "pairwise.complete.obs"),
              cor_f7 = cor(inf_mean, lead(daily_cases_15d_f, n = 7), use = "pairwise.complete.obs"),
              cor_f8 = cor(inf_mean, lead(daily_cases_15d_f, n = 8), use = "pairwise.complete.obs"),
              cor_f9 = cor(inf_mean, lead(daily_cases_15d_f, n = 9), use = "pairwise.complete.obs"),
              cor_f10 = cor(inf_mean, lead(daily_cases_15d_f, n = 10), use = "pairwise.complete.obs"),
              cor_f11 = cor(inf_mean, lead(daily_cases_15d_f, n = 11), use = "pairwise.complete.obs"),
              cor_f12 = cor(inf_mean, lead(daily_cases_15d_f, n = 12), use = "pairwise.complete.obs"),
              cor_f13 = cor(inf_mean, lead(daily_cases_15d_f, n = 13), use = "pairwise.complete.obs"),
              cor_f14 = cor(inf_mean, lead(daily_cases_15d_f, n = 14), use = "pairwise.complete.obs"),
              cor_f15 = cor(inf_mean, lead(daily_cases_15d_f, n = 15), use = "pairwise.complete.obs"),
              cor_f21 = cor(inf_mean, lead(daily_cases_15d_f, n = 21), use = "pairwise.complete.obs"),
              cor_f28 = cor(inf_mean, lead(daily_cases_15d_f, n = 28), use = "pairwise.complete.obs"),
              )           # %>% View()

write.csv(lead_lag_07, 
             file = paste0(getwd(), "/../output/" ,"lead_lag_07", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE)
#################################



covariants <- read.csv(paste0(file_loc, "/Data/CoVariants_Scrapped3.csv")) #names(bigfile)
names(covariants) <- c("location_name", "variant", "startweek", "endweek", "variantdays")
covariants_wide <- 
  covariants %>% select(-variantdays) %>% 
  mutate(startweek =mdy(startweek), endweek =mdy(endweek)) %>%
  pivot_wider(names_from = variant, values_from = c(startweek, endweek))


jointest <- 
  
  left_join(bigtest, covariants_wide, by=c("location_name" = "location_name")) %>% 
  mutate(date= ymd(date)) %>% 
  mutate(alpha = ((date - startweek_Alpha) >= 0) & (date - endweek_Alpha) <=0) %>%
  mutate(beta = ((date - startweek_Beta) >= 0) & (date - endweek_Beta) <=0) %>%
  mutate(delta = ((date - startweek_Delta) >= 0) & (date - endweek_Delta) <=0) %>%
  mutate(gamma = ((date - startweek_Gamma) >= 0) & (date - endweek_Gamma) <=0) %>% 
  mutate(omicron = ((date - startweek_Omicron) >= 0) & (date - endweek_Omicron) <=0) %>% 
  select(-starts_with("endweek"), -starts_with("startweek")) %>%
  View()

#             col.names = TRUE)
```


##############################################
japan_ts <- 
  bigfile %>% 
    filter(location_name == "Japan") %>% 
    select(date, case_ascetainment) %>% 
    mutate(date= as.Date(date
                         #format = "%d.%m.%Y")
           )) %>%
    rename(ds = date, y =  case_ascetainment)
  
m <- prophet(japan_ts)

fcst <- predict(m, japan_ts)
prophet_plot_components(m, fcst)
  
  
  
  
  
  
  
  
  
  
  
```

```{r selected_bigfile_deprecated, echo=TRUE}
selected_bigfile <- 
  bigfile %>% #filter(location_name %in% list27) %>% 
  group_by(location_name) %>%
  mutate(daily_cases_7d = rollapplyr(daily_cases, 7, mean, fill = NA, align = "right")) %>% 
  mutate(daily_slope = (daily_cases_7d - lag(daily_cases_7d))/daily_cases_7d) %>%
  mutate(inf_mean_7d = rollapplyr(inf_mean, 7, mean, fill = NA, align = "right")) %>%
  mutate(inf_mean_7d_f = rollapplyr(inf_mean, 7, mean, fill = NA, align = "left")) %>%
  mutate(daily_cases_7d_f = rollapplyr(daily_cases, 7, mean, fill = NA, align = "left")) %>%
  mutate(daily_cases_7d_c = rollapplyr(daily_cases, 7, mean, fill = NA, align = "center")) %>%
  mutate(inf_mean_7d_c = rollapplyr(inf_mean, 7, mean, fill = NA, align = "center")) %>%
  mutate(daily_cases_15d = rollapplyr(daily_cases, 15, mean, fill = NA, align = "right")) %>%
  mutate(daily_cases_15d_c = rollapplyr(daily_cases, 15, mean, fill = NA, align = "center")) %>%
  
  mutate(daily_cases_15d_f = rollapplyr(daily_cases, 15, mean, fill = NA, align = "left")) %>%
  mutate(inf_mean_15d_f = rollapplyr(inf_mean, 15, mean, fill = NA, align = "left")) %>%
  
  #idr_v7
  mutate(daily_cases_14d_f = rollapplyr(daily_cases, 14, mean, fill = NA, align = "left")) %>%
  mutate(inf_mean_14d_f = rollapplyr(inf_mean, 14, mean, fill = NA, align = "left")) %>%

  mutate(idr_v1 = daily_cases_7d/inf_mean) %>%
  mutate(idr_v2 = daily_cases_7d/inf_mean_7d) %>% 
  mutate(idr_v3 = daily_cases_7d_c/inf_mean) %>% 
  mutate(idr_v4 = daily_cases_15d_c/inf_mean) %>% 
  mutate(idr_v5 = daily_cases_15d/inf_mean) %>%
  mutate(idr_v6 = daily_cases_7d_f/inf_mean) %>%
  mutate(idr_v7 = daily_cases_7d_f/inf_mean_7d_f) %>%
  mutate(idr_v8 = daily_cases_14d_f/inf_mean_14d_f) %>%
  mutate(idr_v9 = daily_cases_14d_f/inf_mean) %>%
  mutate(idr_v10 = daily_cases_15d_f/inf_mean) %>%
  mutate(idr_v11 = daily_cases_15d_f/inf_mean_15d_f)

#selected_bigfile %>% select(date, location_name, idr_v7) %>% 
#  filter(idr_v7>1) %>%
#  group_by(location_name) %>% count(location_name) %>% View()

  #calculate idr_s with a lag
```
##Calculate underreporting as a percentage
```{r under_report, echo=TRUE}
#calculate under_reports by country and drop missing values
data_under <- 
  data_stack %>%
# Create a column for the 7 day moving average cases/inf by location using zoo::rollapplyr
  group_by(location_name) %>%
  mutate(
    #inf_mean_7d = rollapplyr(inf_mean, 7, mean, fill = NA, align = "right"),
    daily_cases_7d = rollapplyr(daily_cases, 7, mean, fill = NA, align = "right")
    ) %>%
  select(location_name, date, inf_mean, daily_cases, daily_cases_7d) %>%
 #drop weeks with 0 predicted cases, mostly from March and April 2020 in some islands
  #filter(inf_mean_7d != 0 & !is.na(inf_mean_7d) ) %>% 
  ungroup() %>%
# Calculate case ascertainment as reported cases (7day avg / inf_mean) after discussion with Hannah
  # denominator is not average
  mutate(case_ascetainment = daily_cases_7d/inf_mean) %>% 
# convert date column to year-quarter format
  mutate(year_quarter= paste0(year(date), "Q", quarter(date)))
  #hist(., freq=TRUE, breaks = 1000)

#Add region designation
data_regions <- 
  left_join(data_under, regions, by="location_name") %>% 
  #keep only countries in the 'regions' dataset
  filter(!is.na(region)) 

```

```{r summarize_ihme, echo=TRUE}
stats_country_ranks <- 
  data_regions %>% group_by(location_name) %>%
  summarize(
        na_daily_cases = sum(is.na(daily_cases)),
        zero_daily_cases = sum(daily_cases==0, na.rm = TRUE)
        ) %>% 
  mutate(nazero_daily_cases = na_daily_cases - 110 + zero_daily_cases) %>%
  #arrange by descending missingness score, nazero_daily_cases
  arrange(desc(nazero_daily_cases)) %>%
  mutate(completeness_rank = rank(nazero_daily_cases, ties.method = "random"))

#generate summary stats by one or two grouping variables
summarize_ihme_backup <- function(ihme_data, var1, var2 = ""){
  ihme_data %>%
    filter(!is.na(daily_cases_7d)) %>% 
    group_by({{var1}}, {{var2}}) %>% 
    summarize(
      n = sum(!is.na(case_ascetainment)),
      min_date = min(as.Date(date), na.rm = TRUE),
      max_date = max(as.Date(date), na.rm = TRUE),
      mean = mean(case_ascetainment, na.rm = TRUE),
      max = max(case_ascetainment, na.rm = TRUE),
      min = min(case_ascetainment, na.rm = TRUE),
      median = median(case_ascetainment, na.rm = TRUE),
      upper_quartile = quantile(case_ascetainment, 0.75,na.rm = TRUE),
      lower_quartile = quantile(case_ascetainment, 0.25, na.rm = TRUE)
  )
}

summarize_ihme <- function(ihme_data, var1, var2 = ""){
  ihme_data %>%
    #filter(!is.na(daily_cases_7d)) %>% 
    group_by({{var1}}, {{var2}}) %>% 
    summarize(
      n_ascert = sum(!is.na(case_ascetainment)),
      n_daily_cases = sum(!is.na(daily_cases)),
      NAs = sum(is.na(daily_cases)),
      n_zeros = sum(!is.na(daily_cases) & (daily_cases == 0)),
      n_1to9 = sum(!is.na(daily_cases) & (daily_cases <10) & (daily_cases >0)),
      min_date = min(as.Date(date), na.rm = TRUE),
      max_date = max(as.Date(date), na.rm = TRUE),
      mean = mean(case_ascetainment, na.rm = TRUE),
      max = max(case_ascetainment, na.rm = TRUE),
      min = min(case_ascetainment, na.rm = TRUE),
      median = median(case_ascetainment, na.rm = TRUE),
      upper_quartile = quantile(case_ascetainment, 0.75,na.rm = TRUE),
      lower_quartile = quantile(case_ascetainment, 0.25, na.rm = TRUE)
  )
}

# calculate summary stats for region and country and by quarter
stats_region <- summarize_ihme(data_regions, region)
stats_loc <- summarize_ihme(data_regions, location_name)
stats_loc_qtr <- summarize_ihme(data_regions, location_name, year_quarter)
stats_region_qtr <- summarize_ihme(data_regions, region, year_quarter)

#export summary stats
for (name in c("stats_region", "stats_loc", "stats_loc_qtr", "stats_region_qtr", "stats_country_ranks")){
  df <- get(name)
  write.xlsx(df, file = paste0(name, ".xlsx"), rowNames = FALSE, colNames = TRUE)
}

```

##Export country level and regional data for excel
```{r under_report, echo=TRUE}
#save big file
write.csv(data_regions, 
             file = paste0("./output/" ,"bigfile", ".csv"),
             quote = TRUE,
             na = "",
             row.names = FALSE,
             col.names = TRUE)

#save big file
write.xlsx(data_regions, 
             file = paste0("./output/" ,"bigfile", ".xlsx"),
             colNames = TRUE,
             rowNames = FALSE)

places <- sort(as.vector(data_regions$location_name)) %>% unique()
# write excel files for each country
for (place in places){
  data_regions %>% 
  filter(location_name == place) %>% 
  write.xlsx(., 
             file = paste0("./output/" ,place, ".xlsx"),
             colNames = TRUE,
             rowNames = FALSE)
}

# write excel files for each continent
##Need to summarize by day first
for (continent in 
     unique(as.vector(data_regions$region))){
  data_regions %>% 
  filter(region == continent) %>% 
  write.xlsx(., 
             file = paste0("./output/" ,continent, ".xlsx"),
             colNames = TRUE,
             rowNames = FALSE)
}


```
## Make line plots and barcharts
```{r plots, echo=TRUE}
#1 Create line plots for each country and #2) save as pdfs
# create plot
df <- data_regions %>% filter(location_name == "United States of America")
ggplot(df, 
       aes(year_quarter, under_report)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))



  geom_line() +
  labs(x = "Date", y = "Under reports for USA") +
  ggtitle("Number of cases over time")

ggplot(df, 
       aes(x = date, y = under_report)) + 
  geom_line() +
  labs(x = "Date", y = "Under reports for USA") +
  ggtitle("Number of cases over time")


```


##Older code
```{r backup, echo=TRUE}
# View the imported data
View(country_groups)

# check overlaps
# need a clean list of countries by region using world bank format
# a clean list of US states
#All location names
location_vec <- data_under[["location_name"]] %>% unique()

#All countries from World Bank
world <- 
  country_groups %>% 
	filter(GroupName == "World") %>%
	select(CountryName) %>%
	as.vector() %>%
  unlist()

# How many countries are correctly spelt? 
length(location_vec)
intersect(world, location_vec) %>% length() #145

# A list of poor spellings and countries that do not have a model
world_mismatch <- 
  setdiff(world, location_vec) %>% sort() %>% as.data.frame()

location_mismatch <- 
  setdiff(location_vec, world) %>% sort() %>% as.data.frame()

#remove US states
location_mismatch2 <- setdiff(location_mismatch[[1]], as.data.frame(state.name)[[1]]) %>% as.data.frame()


#####################
length(state.name)

setdiff(as.data.frame(state.name)[[1]], location_mismatch[[1]])

```

```{r location_clean, echo=TRUE}
# need to make sure Georgia, USA is not mixed up with Republic of Georgia
data_under %>% 
  #filter(grepl('Macao', location_name)) %>% 
  select(location_name) %>% 
  #View() %>%
  #remove everything in parentheses
  mutate(location_clean = gsub("\\ \\(.*\\)", "", location_name)) %>%
  mutate(location_clean = gsub("^Macao.*", "Macao", location_clean)) %>%
  select(location_clean) %>% table() %>% View()
```
## Group IHME data by location and calculate summary statistics
```{r summary_table}
# 1) for each location summarize Max date, min date, mean, median, max, min, upper and lower quartile
summary_table <- data_under %>% 
  filter(!is.na(inf_mean))
  group_by(location_name) %>%
  summarize(
    n = sum(!is.na(inf_mean)),
    min_date = min(as.Date(date), na.rm = TRUE),
    max_date = max(as.Date(date), na.rm = TRUE),
    mean = mean(under_report, na.rm = TRUE),
    max = max(under_report, na.rm = TRUE),
    min = min(under_report, na.rm = TRUE),
    median = median(under_report, na.rm = TRUE),
    upper_quartile = quantile(under_report, 0.75,na.rm = TRUE),
    lower_quartile = quantile(under_report, 0.25, na.rm = TRUE)
  )

# View the resulting summary table
View(summary_table)
```

## Calculate breakpoints for time series data
```{r summary_table}
#To conduct statistical methods detection of breakpoints in time series data using Chow test, CUSUM test, and Pettitt's test, you can use the strucchange package in R. Here's an example code for each of the three methods:

#Chow test:
library(strucchange)
# create a time series object
ts_data <- ts(your_data, start = start_year, frequency = 12)

# perform Chow test
chow_test <- breakpoints(ts_data ~ 1)
summary(chow_test)

#CUSUM test:
# perform CUSUM test
cusum_test <- sctest(ts_data ~ 1, type = "CUSUM")
summary(cusum_test)

#Pettitt's test:
# perform Pettitt's test
pettitt_test <- sctest(ts_data ~ 1, type = "Pettitt")
summary(pettitt_test)
#Note that in the above code, your_data should be replaced with the name of your time series data, and start_year should be replaced with the start year of your time series. Also, you can adjust the frequency argument depending on the frequency of your time series (12 if it is monthly, 4 if it is quarterly, etc.).

```

## Including Plots



You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this: