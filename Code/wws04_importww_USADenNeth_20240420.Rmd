---
title: "ImportWastewater"
author: "Mustapha Mustapha"
date: "2024-03-06"
output: html_document
---
## This is a script that imports wastewater and hospitalization by country
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# April 2023: Undercounting COVID Cases
# clear R's brain
dir.create(tempdir()) # solve Error in file(out, "wt") : cannot open the connection
rm( list = ls())
# load libraries
preq = c( "tidyverse","ggpmisc", "gridExtra", "ggfortify", "scales", 
          "readxl", "readr", "stats", "haven", "Matrix", "foreign",
          "zoo", "prophet", "corrr", "broom", "usethis", "rvest", "data.table")
#for (y in preq) install.packages(y, dep = TRUE)
sapply(preq, library, character.only=T)
# source functions from file in same directory as this script

```

#global variables
```{r setup_2, echo=TRUE}
getwd()
#rm( list = ls())
#file_loc <- "C:/Users/mustam23/OneDrive\ -\ Pfizer/Documents/Projects/wastewater/"
if (!grepl("Code", getwd())) {
  file_loc <- paste0(getwd())
} else {
  file_loc <- paste0(getwd(), "/..")
}
data_loc <- paste0(file_loc, "/data_downloads/") # a location for data files 
# check if the string contains "mustam23"
work_laptop <- grepl("mustam23", getwd())

#setwd(dirname(getwd()))
#source("Code/epiweek_to_date_function.R", chdir=T)


```
#import bigfile
```{r import_bigfile, echo=TRUE}
# read the big file
bigfile <- read.csv(paste0(data_loc, "/bigfile.csv"))
    #select all date columns and convert them to date
    selected_columns <- names(bigfile)[grep("start_|end_|date", names(bigfile))]
    bigfile <- bigfile %>% mutate_at(selected_columns, ymd) 

```

#below is a list of all files we want to import and modify

```{r define_filenames, echo=TRUE}

# <- "Austria 20240304 dl_blverlauf.csv"
ww_dk <- "Denmark 2024-02-28_dk_wastewater_data.csv"
cases_den <- "Denmark 20240304 03_confirmed_cases_dead_admitted_sex.csv"
hosp_den <- "Denmark 20240304 06_new_admissions_region_day.csv"
cases2_den <- "Denmark 20240304 08_confirmed_cases_regions.csv"
ww_usa <- "United States 20240305 wastewater_surveillance_viral_activity_level_over_time_data.csv"
hosp2_usa <- "data_table_for_currently_hospitalized_covid19_patients_-_the_united_states.csv"
hosp_usa <- "data_table_for_weekly_covid19_hospital_admissions_-_the_united_states.csv"
death_usa <- "data_table_for_weekly_deaths__the_united_states.csv"

ww_neth <- "Netherlands_download_weekly_ww.tab"

```
#functions next_saturday, epiweek_to_date
```{r epiweek_to_date_function, echo=TRUE}

next_saturday <- function(date){
  date + 7 - match(weekdays(date), 
                   c("Sunday", "Monday","Tuesday","Wednesday",
                     "Thursday","Friday", "Saturday"))
}

# write a function with a single input year that returns a correction factor of -3 if the year is 2020, 2 if the year is 2021, 1 if the year is 2022, 0 if the year is 2023, -1 if the year is 2024

correction_factor <- function(years) {
  # Force years to be integers
  years <- as.numeric(years)
  # Initialize vector to store results
  factors <- numeric(length(years))
  for (i in seq_along(years)) {
    year <- years[i]
    if (year == 2019){
      factors[i] <- +5
    } else if (year == 2020) {
      factors[i] <- -3
    } else if (year == 2021) {
      factors[i] <- 2
    } else if (year == 2022) {
      factors[i] <- 1
    } else if (year == 2023) {
      factors[i] <- 0
    } else if (year == 2024) {
      factors[i] <- -1
    } else if (year == 2025) {
      factors[i] <- -3
    } else {
      factors[i] <- NA
    }
  }
  return(factors)
}

epiweek_to_date <- function(Year = 2020, Week =1) {
  #force Year and Week to be integers
  Year <- as.integer(Year)
  Week <- as.integer(Week)
  #return the date of the first day of the week
  return(as.Date(paste0(as.character(Year), "-01-01")) + 7 * as.integer(Week) - 1 + correction_factor(Year))
}

```
#date to cdc date function
```{r date_tocdcdate_function, echo=TRUE}
# The function takes a date as input and returns the corresponding CDC datethe closest epiweek. source https://ndc.services.cdc.gov/wp-content/uploads/2021/02/MMWR_Week_overview.pdf
# next_saturday() probably works better here

date_to_cdcdate <- function(date) {
  #force date to be a date
  date <- as.Date(date)
  year = year(date)
  day = as.numeric(date - as.Date(paste0(year, "-01-01")))
  #calculate number of days from the beginning of the year
  week = as.integer(day/7) + 1
  #calculate the week number
  year_week = paste0(year, "-", week) 
  #calculate the year-week
  cdcdate = epiweek_to_date(year, week) 
  diff = cdcdate -date
  #calculate the difference between the date and the epiweek
  week = ifelse(diff > 3, week - 1, week)
  #adjust week number if the difference between the date and the epiweek is greater than 3
  week = ifelse(diff < -3, week + 1, week) 
  #adjust week number if the difference between the date and the epiweek is less than -3
  cdcdate = epiweek_to_date(year, week)
  return(cdcdate)
}

```
#import OWID data
```{r import_owid, echo=TRUE}
# import OWID data
owid <- 
  read.csv(paste0(data_loc, "owid-covid-hospitalizations.csv")) %>%
  mutate(date = ymd(date),
         value = as.numeric(value),
         weekday = weekdays(date)) %>%
  rename(location_name = entity) %>%
  filter(grepl("hospital", indicator))

```
#import wastewater and deaths data
```{r import_files, echo=TRUE}
#import the files ww_dk, cases_den, hosp_den, cases2_den, ww_usa, hosp2_usa, hosp_usa, death_usa

ww_dk_import <- 
  read.csv(paste0(data_loc, "/", ww_dk)) %>%
  mutate(date = ymd(date), location_name = "Denmark") %>%
  rename(viral_load = rna_mean_faeces, notes = lab) %>%
  select(date, location_name, viral_load, notes) %>%
  mutate(weekday = weekdays(date),
         next_saturday = next_saturday(date))

cases_den_import <-   #hospitalization variable does not match OWID data
  read.csv(paste0(data_loc, "/", cases_den), sep = ";",
           check.names = FALSE) %>%
  #hack to rename all variables using a vector
  rename_with(
    ~ c("Region_code", "Region", "Sampling_date", "Sex", "Total_cases", 
        "Deaths", "Admissions", "Cumulative_deaths", "Cumulative_confirmedcases", 
        "Cumulative_admissions", "Timestamp")
    ) %>%
  mutate(date = ymd(Sampling_date)) %>%
  group_by(date) %>%
  summarize(cases = sum(Total_cases), deaths = sum(Deaths), hosp_alt = sum(Admissions)) %>%
  #hospitalization variable does not match OWID data
  mutate(location_name = "Denmark", 
         cases_wkly = rollapplyr(cases, 7, sum, fill = NA, align = "right"), 
         deaths_wkly = rollapplyr(deaths, 7, sum, fill = NA, align = "right"),
         hosp_alt_wkly = rollapplyr(hosp_alt, 7, sum, fill = NA, align = "right")
         ) %>%
  mutate(weekday = weekdays(date),
         next_saturday = next_saturday(date))

hosp_den_import <-   #hosp_new matches new hospitalizations in OWID data
  read.csv(paste0(data_loc, "/", hosp_den), sep = ";",
           check.names = FALSE) %>%
  rename_with(
    ~ c("Region_code", "region", "date", "new_admissions", "timestamp")
    ) %>%
  mutate(date = ymd(date)) %>%
  group_by(date) %>%
  summarize(hosp_new = sum(new_admissions)) %>%
  #hosp_new matches new hospitalizations in OWID data
  mutate(location_name = "Denmark",
         hosp_new_wkly = rollapplyr(hosp_new, 7, sum, fill = NA, align = "right"),
         weekday = weekdays(date),
         next_saturday = next_saturday(date))
#cases2_den_import <- read.csv(paste0(data_loc, "/", cases2_den))
ww_usa_import <- 
  read.csv(paste0(data_loc, "/", ww_usa), skip = 2) %>%
  mutate(date = ymd(Date), location_name = "United States") %>%
  rename(viral_load = Viral.Activity.Level) %>%
  select(date, location_name, viral_load) %>% 
  mutate(weekday = weekdays(date),
         next_saturday = next_saturday(date))

hosp2_usa_import_current <- 
  read.csv(paste0(data_loc, "/", hosp2_usa), skip = 2) %>%
  rename(location_name = Geography,
         date = Date,
         hosp_current = Currently.Hospitalized.COVID.19.Patients
         ) %>%
  mutate(date = mdy(date), hosp_current = as.numeric(hosp_current),
        weekday = weekdays(date),
         next_saturday = next_saturday(date))

hosp_usa_import_new <- 
  read.csv(paste0(data_loc, "/", hosp_usa), skip =2) %>%
  rename(location_name = Geography,
         date = Date,
         hosp_new = Weekly.COVID.19.Hospital.Admissions
         ) %>%
  mutate(date = mdy(date), hosp_new = as.numeric(hosp_new),
         weekday = weekdays(date),
         next_saturday = next_saturday(date))

death_usa_import <- 
  read.csv(paste0(data_loc, "/", death_usa), skip = 2) %>%
  rename(location_name = Geography,
         date = Date,
         deaths = Weekly.Deaths,
         notes = Death.Data.As.Of
         ) %>%
  mutate(date = mdy(date), deaths = as.numeric(deaths), 
         weekday = weekdays(date),
         next_saturday = next_saturday(date))

#import Netherlands data from ww_neth
ww_neth_import <- 
  read.delim(paste0(data_loc, "/", ww_neth) 
             ) %>%
  mutate(date = epiweek_to_date(Year, Week),
         location_name = "Netherlands",
         weekday= weekdays(date)) %>%
  rename(viral_load = WW) %>%
  select(date, location_name, viral_load, weekday) %>%
  filter(!is.na(viral_load))

hosp_neth_import <- 
  # take OWID dataset and filter for Netherlands and hospitalizations
  owid %>%
  rename(owid_date = date) %>% # renaming this to keep tabs on original date from owid
  filter(location_name == "Netherlands" &
           grepl("Weekly new", indicator)) %>%
  arrange(indicator, owid_date) %>%
  #for each date, calculate the next saturday and how many days until next saturday
  mutate(
    next_saturday = next_saturday(owid_date),
    until_saturday = next_saturday - owid_date
    ) %>%
  #group by indicator and next saturday
  group_by(indicator, next_saturday) %>%
  #for each group, calculate the maximum date, which is the most recent date we have data for that week
  mutate(max_date = max(owid_date),
         indicator = gsub(" ", "_", indicator)) %>%
  #filter for the rows where the date is the maximum date, which is the most recent date we have data for that week
  filter(max_date == owid_date) %>% 
  rename(date = next_saturday) %>%
  select(indicator, location_name,owid_date, date, value, weekday) %>% ungroup() %>%
  #create columns for weekly new hospitalizations and weekly new hospitalizations per million
  pivot_wider(names_from = indicator, values_from = value) %>%
  rename(
    hosp_new = Weekly_new_hospital_admissions,
    hosp_new_permill = Weekly_new_hospital_admissions_per_million
  )



```

#summarize everything
```{r summarize_ww, echo=TRUE}
  ww_dk_import %>%
      summarize(min_date = min(date), 
            max_date = max(date), 
            max_viral_load = max(viral_load, na.rm = TRUE),
            min_viral_load = min(viral_load, na.rm = TRUE),
            count = n())

```

#merge wastewater and hospitalization data
```{r merge_ww_hosp, echo=TRUE}

ww_dk_hosp <-
  full_join(ww_dk_import, hosp_den_import, by = c("date", "location_name")) %>%
  full_join(., cases_den_import, by = c("date", "location_name")) %>%
  full_join(., bigfile %>% ungroup() %>% filter(location_name == "Denmark"), 
            by = c("date", "location_name")) %>%
  arrange(date) %>%
  select(date, location_name, viral_load, hosp_new, hosp_new_wkly, 
         cases, inf_mean, daily_cases, variant, subvariant) %>%
  
  mutate( subvariant = case_when(date >= as.Date("2023-02-27") &
                                date < as.Date("2023-11-20") ~ "XBB", 
                              date >= as.Date("2023-11-20") ~ "JN.1",
                              TRUE ~ subvariant),
          variant = case_when(date >= as.Date("2022-02-02") ~ "Omicron",
                             TRUE ~ variant
                             ),
          inf_mean_7dts = 
           rollapplyr(inf_mean, 7, sum, fill = NA, align = "right"),
          daily_cases_7dts = 
           rollapplyr(daily_cases, 7, sum, fill = NA, align = "right"),
          cases_7dts = 
           rollapplyr(cases, 7, sum, fill = NA, align = "right")
          ) 

den_dataset <- ww_dk_hosp %>%
    mutate(
    log_viral_load = log(viral_load),
    lead1_viral_load = lead(viral_load, n = 1),
    lead2_viral_load = lead(viral_load, n = 2),
    lead3_viral_load = lead(viral_load, n = 3),
    lead4_viral_load = lead(viral_load, n = 4),
    lag1_viral_load = lag(viral_load, n = 1),
    lag2_viral_load = lag(viral_load, n = 2),
    lag3_viral_load = lag(viral_load, n = 3),
    lag4_viral_load = lag(viral_load, n = 4)
    )


#%>% View()
  #Den BA45/ends BQ.1 begins Nov 21 2022
  #Den BQ.1 never reached 4 weeks prevalence
  #Den XBB start Feb  27, 2023
  #Den JN.1 start November 20, 2023

```
#ba1 = case_when(
#  ((date >= start_BA.1) & (date < end_BA.1)) ~ 1, .default = 0),
```{r merge_ww_hosp2, echo=TRUE}
#merge wastewater and hosp data for USA
ww_usa_hosp <-
  full_join(ww_usa_import, hosp2_usa_import_current, by = c("date", "location_name")) %>%
  full_join(., hosp_usa_import_new, by = c("date", "location_name")) %>%
  full_join(., death_usa_import, by = c("date", "location_name")) %>%
  select(date, viral_load, hosp_current, hosp_new, deaths) 

usa_dataset <- 
  bigfile %>% #ungroup() %>% 
  #              mutate(variant = replace_na(variant, "NA")) %>% 
  filter(location_name == "United States of America") %>%
  select(date, location_name, inf_mean, daily_cases, variant, subvariant) %>%
  mutate(inf_mean_7dts = 
           rollapplyr(inf_mean, 7, sum, fill = NA, align = "right"),
         daily_cases_7dts = 
           rollapplyr(daily_cases, 7, sum, fill = NA, align = "right")
         ) %>%
  full_join(., ww_usa_hosp, by = "date") %>%
  arrange(date) %>%
  mutate(subvariant = case_when(date >= as.Date("2022-10-01") &
                                date < as.Date("2023-01-16") ~ "BA.4/BA.5", 
                                date >= as.Date("2023-01-16") &
                                date < as.Date("2023-12-18") ~ "XBB", 
                                date >= as.Date("2023-12-18") ~ "JN.1",
                                TRUE ~ subvariant),
                  variant = case_when(date >= as.Date("2022-02-02") ~ "Omicron",
                             TRUE ~ variant
                             )) %>%
    mutate(
      log_viral_load = log(viral_load),
      lead1_viral_load = lead(viral_load, n = 1),
      lead2_viral_load = lead(viral_load, n = 2),
      lead3_viral_load = lead(viral_load, n = 3),
      lead4_viral_load = lead(viral_load, n = 4),
      lag1_viral_load = lag(viral_load, n = 1),
      lag2_viral_load = lag(viral_load, n = 2),
      lag3_viral_load = lag(viral_load, n = 3),
      lag4_viral_load = lag(viral_load, n = 4)
    )


neth_dataset <- 
  bigfile %>% 
  filter(location_name == "Netherlands") %>%
  select(date, location_name, inf_mean, daily_cases, variant, subvariant) %>%
  mutate(inf_mean_7dts = 
           rollapplyr(inf_mean, 7, sum, fill = NA, align = "right"),
         daily_cases_7dts = 
           rollapplyr(daily_cases, 7, sum, fill = NA, align = "right")
         ) %>%
  full_join( . , hosp_neth_import, by = c("date", "location_name")) %>%
  full_join( . , ww_neth_import, by = c("date", "location_name")) %>%
  arrange(date) %>%
  #Netherlands Dates from Covariants.org as of 2024-05-16
  mutate(subvariant = case_when(date >= as.Date("2022-12-05") &
                                date < as.Date("2023-11-20") ~ "XBB", 
                                date >= as.Date("2023-11-20") ~ "JN.1",
                                TRUE ~ subvariant),
         variant = case_when(date >= as.Date("2022-02-02") ~ "Omicron",
                             TRUE ~ variant
                             )) %>%
  mutate(
    log_viral_load = log(viral_load),
    lead1_viral_load = lead(viral_load, n = 1),
    lead2_viral_load = lead(viral_load, n = 2),
    lead3_viral_load = lead(viral_load, n = 3),
    lead4_viral_load = lead(viral_load, n = 4),
    lag1_viral_load = lag(viral_load, n = 1),
    lag2_viral_load = lag(viral_load, n = 2),
    lag3_viral_load = lag(viral_load, n = 3),
    lag4_viral_load = lag(viral_load, n = 4)
  )



```

